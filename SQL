-- -- Active: 1701846489377@@127.0.0.1@3306@Covid
SELECT * FROM deaths;
SELECT * FROM vaccination;

-- Creating a new temporary table "TotalVaccinated"

CREATE TABLE vaccine_death_rates AS
WITH TotalVaccination AS (
    SELECT
        iso_code,
        location,
        AVG(people_fully_vaccinated) AS total_vaccinated
    FROM
        vaccination
    GROUP BY
        iso_code, location
), DeathRateCTE AS (
    SELECT    
        iso_code,
        location,
        AVG(population) AS population,
        AVG(total_cases) AS total_cases,
        AVG(total_deaths) AS total_deaths,
        (AVG(total_deaths) / AVG(total_cases)) * 100 AS death_rate
    FROM
        deaths
    GROUP BY
        iso_code, location
)
SELECT 
    TotalVaccination.iso_code,
    TotalVaccination.location,
    DeathRateCTE.death_rate,
    (TotalVaccination.total_vaccinated / DeathRateCTE.population) * 100 AS vaccination_rate
    FROM TotalVaccination INNER JOIN
    DeathRateCTE ON TotalVaccination.iso_code = DeathRateCTE.iso_code
    WHERE TotalVaccination.total_vaccinated IS NOT NULL AND DeathRateCTE.death_rate IS NOT NULL;

SELECT * FROM vaccine_death_rates